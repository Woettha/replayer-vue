# Node.js with Vue
# Build a Node.js project that uses Vue.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
    - main

pool:
    vmImage: ubuntu-latest

steps:
    - task: NodeTool@0
      inputs:
          versionSpec: '10.x'
      displayName: 'Install Node.js'

    - script: |
          npm install
          npm test 
          npm run build
      displayName: 'npm install and build'

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
          testRunner: JUnit
          testResultsFiles: '**/junit.xml'

    - task: PublishPipelineArtifact@1
      inputs:
          targetPath: $(System.DefaultWorkingDirectory)/dist
          artifactName: replayer-pwa-distribution
    # FTP upload
    # Upload files using FTP
    - task: FtpUpload@2
      inputs:
          credentialsOption: 'inputs' # Options: serviceEndpoint, inputs
          #serverEndpoint: # Required when credentialsOption == ServiceEndpoint
          #The FTP server URL must begin with ftp:// or ftps://
          serverUrl: 'ftps://s052.cyon.net' # Required when credentialsOption == Inputs
          username: 'web-devel-replayer@replayer.app' # Required when credentialsOption == Inputs
          password: 'super-long-and-secure-password' # Required when credentialsOption == Inputs
          rootDirectory: $(System.DefaultWorkingDirectory)/dist
          filePatterns: '**'
          #Just use the defined root for the FTP user
          remoteDirectory: '/'
          #keep the directory, as it's the root anyway
          clean: false
          #removing content does not work, because I have static files that are not allowed to access for this upload task
          cleanContents: false
          preservePaths: true
          #trustSSL: false
